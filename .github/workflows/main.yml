name: All

on:
  push:
    tags:
      - '*'
  
  workflow_dispatch:

jobs:

  Realese:
    runs-on: macos-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v2.4.0
      
    - run: |
        echo "APP_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        echo "APP_BUILD=${GITHUB_SHA::7}" >> $GITHUB_ENV
              
        
    - name: Package
      run: |
        fastlane run increment_version_number_in_plist version_number:$APP_VERSION
        fastlane run increment_build_number_in_plist build_number:$APP_BUILD
        fastlane package

    - name: Create
      run: |
        brew install create-dmg
        create-dmg \
        --volicon assets/volicon.icns \
        --hdiutil-quiet \
        --app-drop-link 0 30  \
        $APP_NAME.dmg $APP_NAME.app

    - name: Changelogs
      run: | 
      
       signature=`$PWD/assets/sign_update -s $SPARKLE_KEY $APP_NAME.dmg`
       
       enclosure="
       <?
       <enclosure 
       url=\"$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/releases/download/$APP_VERSION/$APP_NAME.dmg\" 
       sparkle:version=\"$APP_BUILD\" 
       sparkle:shortVersionString=\"$APP_VERSION\" 
       $signature
       type=\"application/octet-stream\" 
       />
       "
     
       changelog0=`cat CHANGELOG.md`
       changelog0=${changelog0%%---*}
       changelog0=${changelog0#*###}
       changelog0="###$changelog0"
       
       changelog1=`cat CHANGELOG_SC.md`
       changelog1=${changelog1%%---*}
       changelog1=${changelog1#*###}
       changelog1="
       <?
       ###$changelog1
       "
       
       echo "$changelog0$changelog1$enclosure" > Release.md
       
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        body_path: Release.md
        files: ${{ env.APP_NAME }}.dmg
 
 
    - name: Rebuild ðŸš€ 
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.PERSONAL_TOKEN }}
        script: |
          github.rest.repos.requestPagesBuild({
            owner: context.repo.owner,
              repo: context.repo.repo,
            })
              
env:
  APP_NAME: ${{ secrets.APP_SCHEME }}
  SPARKLE_KEY: ${{ secrets.SPARKLE_KEY }}
